## Результаты выполненной работы (Фаза 2 и 3: Логика кампаний и модификация движка)

**Что было сделано:**

1.  **Реализация логики учебных кампаний (Фаза 2):**
    *   **Обновлены модели данных (`models.py`):** Добавлены новые датаклассы `Campaign`, `UserInfo`, `UserResult` и перечисления (`Enum`) для типизации статусов, типов кампаний и назначений. Сессия (`Session`) расширена для хранения `campaign_name` и `mode`.
    *   **Расширен сервис Google Sheets (`services/google_sheets.py`):**
        *   Реализована ключевая функция `get_active_campaign_for_user`, которая находит доступную для пользователя кампанию, учитывая ее дедлайн, тип назначения (на всех, на автоколонну, на `telegram_id`) и статус прохождения (включая возможность пересдачи по статусу "разрешена пересдача").
        *   Добавлены вспомогательные функции `get_all_campaigns` и `get_user_results`.
    *   **Обновлен стартовый хендлер (`handlers/common.py`):**
        *   Логика команды `/start` полностью переработана. Теперь она ищет активную кампанию и, если находит, предлагает пользователю ее пройти. Старый механизм общего теста удален из этого потока.
        *   Создан новый обработчик `start_campaign_callback` для кнопки "Начать", который выполняет проверки и запускает процесс тестирования.

2.  **Модификация движка тестирования (Фаза 3):**
    *   **Доработан парсинг вопросов:** Функция `read_questions` теперь считывает колонки `критический_вопрос` (boolean) и `пояснение` (text).
    *   **Обновлен обработчик ответов (`handlers/test.py`):**
        *   Реализована логика **критических вопросов**: при неверном ответе на такой вопрос тест немедленно завершается с соответствующей пометкой.
        *   Реализована логика режима **"Обучение"**: если кампания имеет такой тип, при неверном ответе бот отправляет пользователю `пояснение`.
    *   **Обновлена запись результатов:** Функция `write_result` теперь сохраняет в лист "Результаты" `название_кампании` и `итоговый_статус` (`успешно`/`не пройдено`).
    *   **Проведен рефакторинг:** FSM-состояния и хендлеры были обновлены и упрощены для соответствия новому потоку, ориентированному на кампании.

---

### Инструкция для тестирования изменений

Вот пошаговая инструкция для проверки реализованного функционала.

#### Шаг 1: Настройка тестовых данных в Google Sheets

Перед запуском убедитесь, что ваши таблицы содержат данные для всех тестовых сценариев.

1.  **Лист "Пользователи"**:
    *   Добавьте свой `telegram_id` (числовой идентификатор вашего аккаунта).
    *   Укажите для себя `статус` = **"подтверждён"**.
    *   Заполните остальные поля. Например: `фио` = "Тестов Тест Тестович", `автоколонна` = **"АК-1"**.

2.  **Лист "Кампании"**:
    *   Создайте **2-3 тестовые кампании**, чтобы проверить логику назначения и режимы:

| название_кампании | дедлайн | тип | тип_назначения | значение_назначения |
| :--- | :--- | :--- | :--- | :--- |
| Обучение АК-1 | *дата в будущем* | **Обучение** | автоколонна | **АК-1** |
| Итоговый тест | *дата в будущем* | **Тестирование** | all | |
| Старая кампания| *дата в прошлом* | Тестирование | all | |

3.  **Лист "Вопросы"**:
    *   Убедитесь, что вопросов больше, чем указано в настройках (`количество вопросов`).
    *   Для одного из вопросов установите `критический_вопрос` = **TRUE** и напишите что-нибудь в колонке `пояснение`.

4.  **Лист "Результаты"**:
    *   Убедитесь, что для вашего `telegram_id` нет записей о прохождении кампаний "Обучение АК-1" и "Итоговый тест". Если есть, удалите их для чистоты теста.

5.  **Лист "Настройки"**:
    *   Проверьте, что все числовые параметры (`количество вопросов`, `количество допустимых ошибок` и др.) заполнены корректно.

#### Шаг 2: Запуск бота

1.  Убедитесь, что ваш файл `.env` содержит все необходимые переменные.
2. Запустите бота с помощью Docker Compose: `docker-compose up --build -d`.

#### Шаг 3: Тестовые сценарии

Выполните эти действия в боте последовательно.

**Сценарий 1: Режим "Обучение" и критический вопрос**

1.  Отправьте боту команду `/start`.
    *   **Ожидание:** Бот предложит вам начать кампанию **"Обучение АК-1"**.
2.  Нажмите кнопку **"Начать"**.
3.  Введите свое ФИО и подтвердите.
4.  Начните тест. Умышленно ответьте на один из **обычных** вопросов **неправильно**.
    *   **Ожидание:** Бот должен написать "❌ Неверно!" и **показать пояснение** к вопросу. Тест продолжится.
5.  Дойдите до **критического вопроса** и также ответьте на него **неправильно**.
    *   **Ожидание:** Тест немедленно завершится с сообщением об ошибке в критическом вопросе.
6.  **Проверка:** В листе **"Результаты"** должна появиться новая строка для кампании "Обучение АК-1" с `итоговый_статус` = **"не пройдено"**.

**Сценарий 2: Логика пересдачи**

1.  Откройте лист **"Результаты"**.
2.  В строке, созданной на предыдущем шаге, измените значение в колонке `итоговый_статус` на **"разрешена пересдача"**.
3.  Вернитесь в бот и снова отправьте команду `/start`.
    *   **Ожидание:** Бот снова должен предложить вам пройти кампанию **"Обучение АК-1"**.

**Сценарий 3: Режим "Тестирование" и успешное завершение**

1.  Пройдите кампанию "Обучение АК-1" до конца, отвечая на все вопросы правильно.
2.  После успешного завершения отправьте команду `/start` еще раз.
    *   **Ожидание:** Бот предложит следующую доступную кампанию — **"Итоговый тест"**.
3.  Начните тест. Умышленно ответьте на один из вопросов **неправильно**.
    *   **Ожидание:** Бот напишет "❌ Неверно!", но **не покажет пояснение**. Тест продолжится.
4.  Завершите тест, ответив на остальные вопросы правильно.
    *   **Ожидание:** Сообщение об успешном прохождении теста.
5.  **Проверка:** В листе **"Результаты"** появится строка для кампании "Итоговый тест" с `итоговый_статус` = **"успешно"**.

**Сценарий 4: Нет доступных кампаний**

1.  После успешного прохождения всех назначенных вам кампаний, снова отправьте `/start`.
    *   **Ожидание:** Бот должен сообщить, что для вас нет доступных кампаний.
