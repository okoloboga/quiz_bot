# Пошаговый план реализации

Этот документ представляет собой чек-лист задач для последовательной разработки нового функционала.

### Фаза 0: Подготовка и настройка

- [ ] 1. **Настроить переменные окружения**: Добавить `OWNER_TELEGRAM_ID` и `ADMIN_TELEGRAM_ID` в файл `.env` или в переменные окружения хостинга.
- [ ] 2. **Обновить структуру Google Sheets**:
    - [ ] Создать лист `Users` с колонками: `telegram_id`, `phone_number`, `full_name`, `motorcade`, `status`.
    - [ ] Создать лист `Campaigns` с колонками: `campaign_name`, `deadline`, `type`, `assignment_type`, `assignment_value`.
    - [ ] В лист `Questions` добавить колонки `is_critical` (Boolean) и `explanation` (Text).
    - [ ] В лист `Results` добавить колонки `final_status` (Text) и `campaign_name` (Text).
- [ ] 3. **Заполнить тестовые данные**: Внести в таблицы несколько примеров (2-3 пользователя с разными статусами, 1-2 кампании, несколько критических вопросов), чтобы обеспечить возможность тестирования на каждом этапе.

### Фаза 1: Регистрация пользователя и контроль доступа

- [ ] 1. **Реализовать FSM для регистрации**:
    - [ ] Определить состояния: `Registration:waiting_for_phone`, `Registration:waiting_for_fio`, `Registration:waiting_for_motorcade`.
    - [ ] Написать хендлеры для каждого шага, которые собирают данные и сохраняют их в `FSMContext`.
- [ ] 2. **Обновить сервис Google Sheets**: Создать функцию для добавления новой строки в лист `Users`.
- [ ] 3. **Завершить флоу регистрации**: Хендлер для последнего шага (ввод автоколонны) должен вызывать функцию из п.2 и очищать состояние FSM.
- [ ] 4. **Реализовать Middleware**: Создать и подключить middleware, которое проверяет статус пользователя в листе `Users` при каждом входящем сообщении, блокируя доступ для неподтверждённых пользователей.

### Фаза 2: Логика учебных кампаний

- [ ] 1. **Создать функцию поиска кампании**: В модуле `services` реализовать функцию `get_active_campaign_for_user(user_id)`, которая инкапсулирует логику поиска доступной кампании для пользователя.
- [ ] 2. **Обновить стартовый хендлер**: Модифицировать хендлер команды `/start` (или `/test`) так, чтобы он вызывал функцию из п.1 и показывал кнопку для старта кампании.
- [ ] 3. **Реализовать Callback-хендлер**: Написать хендлер для обработки нажатия кнопки "Начать кампанию", который проверяет возможность пересдачи и запускает сессию теста.
- [ ] 4. **Расширить структуру сессии**: Добавить в данные сессии в Redis поля `campaign_name` и `mode` (`Обучение`/`Тестирование`).

### Фаза 3: Модификация движка тестирования

- [ ] 1. **Обновить хендлер обработки ответов**:
    - [ ] Добавить проверку на `is_critical`. При неверном ответе на такой вопрос — немедленно завершать тест.
    - [ ] Добавить проверку режима (`mode`). Если режим "Обучение" и ответ неверный — отправлять пользователю пояснение (`explanation`).
- [ ] 2. **Обновить функцию завершения теста**: Модифицировать функцию `finish_test` для корректной записи `campaign_name` и `final_status` в лист `Results`.

### Фаза 4: Пользовательские и административные функции

- [ ] 1. **Реализовать флоу "Обращения к владельцу"**:
    - [ ] Создать FSM и хендлеры для сбора и пересылки сообщения на `OWNER_TELEGRAM_ID`.
- [ ] 2. **Реализовать аналитические команды для администратора**:
    - [ ] Создать хендлеры для команд (`/stats_campaign` и др.), защищённые проверкой `ADMIN_TELEGRAM_ID`.
    - [ ] В сервисе Google Sheets создать функции для сбора и агрегации данных из `Results` для этих отчётов.

### Фаза 5: Фоновые задачи (Уведомления)

- [ ] 1. **Интегрировать `apscheduler`**: Добавить библиотеку в `requirements.txt`.
- [ ] 2. **Создать модуль для scheduler**: Определить в нём функцию `check_deadlines_job`, которая будет находить пользователей для отправки напоминаний.
- [ ] 3. **Настроить запуск**: В `main.py` инициализировать scheduler и добавить в него ежедневную задачу `check_deadlines_job`.

### Фаза 6: Финальное тестирование

- [ ] 1. **Сквозное тестирование регистрации**: Проверить весь путь нового пользователя от команды `/start` до получения статуса "ожидает".
- [ ] 2. **Тестирование контроля доступа**: Убедиться, что пользователь со статусом "ожидает" или "отклонён" не может пользоваться ботом.
- [ ] 3. **Тестирование кампаний**: Проверить запуск, прохождение и завершение кампании в обоих режимах. Проверить оба сценария провала (по счёту и по критическому вопросу).
- [ ] 4. **Тестирование пересдачи**: Вручную изменить статус в `Results` на "разрешена пересдача" и проверить, что тест можно пройти заново.
- [ ] 5. **Тестирование уведомлений**: Проверить корректность работы фоновой задачи (возможно, временно изменив её расписание на более частое для теста).
- [ ] 6. **Тестирование админ-команд и обращений**: Убедиться, что отчёты генерируются корректно и сообщения пересылаются владельцу.
